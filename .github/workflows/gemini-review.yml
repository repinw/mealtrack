name: Gemini Code Review (3 Pro + Tests)

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install libraries
        run: pip install google-generativeai PyGithub

      - name: Create Review Script
        run: |
          cat << 'EOF' > review.py
          import os
          import google.generativeai as genai
          from github import Github

          # --- KONFIGURATION ---
          api_key = os.environ.get('GEMINI_API_KEY')
          if not api_key:
              print("Kein API Key gefunden!")
              exit(1)
          
          genai.configure(api_key=api_key)
          MODEL_NAME = 'gemini-3-pro-preview' # Dein funktionierendes Modell
          
          # --- GITHUB VERBINDUNG ---
          g = Github(os.environ['GITHUB_TOKEN'])
          repo = g.get_repo(os.environ['REPO_NAME'])
          pr = repo.get_pull(int(os.environ['PR_NUMBER']))

          # --- DIFF LADEN ---
          diff_text = ''
          files_analyzed = []
          has_test_files = False
          
          for file in pr.get_files():
              if file.patch and not file.filename.endswith('lock'): 
                  files_analyzed.append(file.filename)
                  diff_text += f'\n\n--- DATEI: {file.filename} ---\n{file.patch}\n'
                  
                  # Grober Check: Sind Test-Dateien im PR dabei?
                  if "test" in file.filename.lower() or "_spec" in file.filename.lower():
                      has_test_files = True

          if not diff_text:
              print('Keine relevanten √Ñnderungen gefunden.')
              exit(0)

          # --- GEMINI PROMPT ANPASSUNG ---
          # Hier sagen wir Gemini, dass es streng auf Tests achten soll
          
          prompt = f'''
          Du bist ein strenger Senior Code Reviewer f√ºr das Projekt 'mealtrack'.
          
          Deine Aufgabe:
          1. Reviewe den Code auf Bugs, Sicherheit und Clean Code.
          2. PR√úFE AUF TESTS: Wurden f√ºr neue Logik oder Funktionen Tests geschrieben?
             (Hinweis: Im aktuellen PR sind Test-Dateien enthalten: {has_test_files})
          3. Pr√ºfe: Kommentare und Namen der Methoden/Funktionen/Klassen m√ºssen auf Englisch sein
          4. Pr√ºfe: Sind Kommentare an den Stellen notwendig? Entferne sie falls nicht
          
          Struktur deiner Antwort (in Markdown):
          
          ### üõ°Ô∏è Review Zusammenfassung
          Gib ein kurzes Urteil ab. Wenn Tests fehlen, schreibe gro√ü: **‚ö†Ô∏è TESTS FEHLEN**
          
          ### üêõ Bugs & Anmerkungen
          Liste kritische Fehler oder Sicherheitsl√ºcken auf.
          
          ### üß™ Fehlende Tests & Szenarien
          Analysiere die neuen Funktionen und liste konkret auf, welche Tests geschrieben werden M√úSSEN.
          Gib Tipps f√ºr:
          - **Happy Path** (Normalfall)
          - **Edge Cases** (Null-Werte, leere Listen, negative Zahlen)
          - **Error Handling** (Was passiert bei Fehlern?)
          
          Dateien im PR: {', '.join(files_analyzed)}
          
          CODE DIFF:
          {diff_text[:90000]} 
          '''

          try:
              model = genai.GenerativeModel(MODEL_NAME)
              response = model.generate_content(prompt)
              review_body = response.text
          except Exception as e:
              review_body = f'‚ùå **Fehler bei der KI-Anfrage:** {str(e)}'

          # --- KOMMENTAR POSTEN ---
          header = f'## ü§ñ Gemini Review ({MODEL_NAME})\n'
          pr.create_issue_comment(header + review_body)
          EOF

      - name: Run Gemini Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
        run: python review.py
