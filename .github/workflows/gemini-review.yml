name: Gemini Code Review (Dev API)

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install libraries
        run: pip install google-generativeai PyGithub

      - name: Create Review Script
        run: |
          cat << 'EOF' > review.py
          import os
          import google.generativeai as genai
          from github import Github

          # --- KONFIGURATION ---
          # Hier lesen wir den API Key sicher aus den Umgebungsvariablen
          api_key = os.environ.get('GEMINI_API_KEY')
          if not api_key:
              print("Kein API Key gefunden!")
              exit(1)
              
          genai.configure(api_key=api_key)

          # Modell-Auswahl
          MODEL_NAME = 'gemini-1.5-pro' 

          try:
              model = genai.GenerativeModel(MODEL_NAME)
          except Exception as e:
              print(f"Fehler beim Laden von {MODEL_NAME}, fallback auf Flash.")
              model = genai.GenerativeModel('gemini-1.5-flash')

          # --- GITHUB VERBINDUNG ---
          g = Github(os.environ['GITHUB_TOKEN'])
          repo = g.get_repo(os.environ['REPO_NAME'])
          pr = repo.get_pull(int(os.environ['PR_NUMBER']))

          # --- DIFF LADEN ---
          diff_text = ''
          files_analyzed = []
          for file in pr.get_files():
              if file.patch and not file.filename.endswith('lock'): 
                  files_analyzed.append(file.filename)
                  diff_text += f'\n\n--- DATEI: {file.filename} ---\n{file.patch}\n'

          if not diff_text:
              print('Keine √Ñnderungen gefunden.')
              exit(0)

          # --- GEMINI FRAGEN ---
          prompt = f'''
          Du bist ein erfahrener Tech Lead und Code Reviewer f√ºr das Projekt 'mealtrack'.
          Deine Aufgabe ist es, den folgenden Code-Diff eines Pull Requests zu pr√ºfen.

          Bitte achte besonders auf:
          1. üêõ **Logikfehler & Bugs**
          2. üõ°Ô∏è **Sicherheit**
          3. üßπ **Clean Code**

          Antworte in klarem Markdown-Format. 
          Sei freundlich, aber pr√§zise.
          Wenn alles gut ist, schreibe nur kurz 'LGTM'.

          Dateien: {', '.join(files_analyzed)}

          CODE-DIFF:
          {diff_text[:60000]} 
          '''

          try:
              response = model.generate_content(prompt)
              review_body = response.text
          except Exception as e:
              review_body = f'‚ùå **Fehler bei der KI-Anfrage:** {str(e)}'

          # --- KOMMENTAR POSTEN ---
          header = f'## ü§ñ Gemini Review ({MODEL_NAME})\n'
          pr.create_issue_comment(header + review_body)
          EOF

      - name: Run Gemini Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
        run: python review.py
