name: Gemini Code Review (3 Pro + Tests)

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  workflow_dispatch:

jobs:
  review:
    # Spart Kosten: L√§uft nicht bei Draft-PRs
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install libraries
        run: pip install google-generativeai PyGithub

      - name: Run Review Script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
        run: |
          cat << 'EOF' > review.py
          import os
          import google.generativeai as genai
          from github import Github

          # --- CONFIG ---
          # Stand 2026: Wir nutzen das neueste 3er Modell wie angefordert
          MODEL_NAME = 'gemini-3-pro-preview' 
          
          api_key = os.environ.get('GEMINI_API_KEY')
          if not api_key:
              print("‚ùå Kein API Key gefunden!")
              exit(1)

          genai.configure(api_key=api_key)

          g = Github(os.environ['GITHUB_TOKEN'])
          repo = g.get_repo(os.environ['REPO_NAME'])
          pr = repo.get_pull(int(os.environ['PR_NUMBER']))

          # --- 1. ANTI-SPAM: Alte Bot-Kommentare l√∂schen ---
          print("üßπ Suche nach alten Bot-Kommentaren...")
          try:
              for comment in pr.get_issue_comments():
                  if "ü§ñ Gemini Review" in comment.body:
                      comment.delete()
                      print(f"   Alten Kommentar {comment.id} gel√∂scht.")
          except Exception as e:
              print(f"‚ö†Ô∏è Konnte Kommentare nicht l√∂schen (Berechtigung?): {e}")

          # --- 2. DIFF LADEN & FILTERN ---
          diff_text = ''
          files_analyzed = []
          has_test_files = False
          # Erweiterte Ignore-Liste f√ºr weniger Token-Verbrauch
          ignored_ext = ['.json', '.md', '.svg', '.png', '.lock', '.yml', '.yaml', '.css', '.scss']

          for file in pr.get_files():
              # Ignoriere gel√∂schte Dateien oder unwichtige Formate
              if file.status == "removed" or any(file.filename.endswith(ext) for ext in ignored_ext):
                  continue
              
              if file.patch:
                  files_analyzed.append(file.filename)
                  diff_text += f'\n\n--- DATEI: {file.filename} ---\n{file.patch}\n'
                  
                  if "test" in file.filename.lower() or "spec" in file.filename.lower():
                      has_test_files = True

          if not diff_text:
              print("‚úÖ Keine review-relevanten √Ñnderungen (Code) gefunden.")
              exit(0)

          # --- 3. PROMPT ---
          # Optimierter Prompt f√ºr Gemini 3 Context
          prompt = f'''
          Du bist ein strenger Senior Code Reviewer f√ºr das Projekt 'mealtrack'.
          
          KONTEXT:
          - Dateien: {', '.join(files_analyzed)}
          - Tests im PR enthalten? {"JA ‚úÖ" if has_test_files else "NEIN ‚ùå (Kritisch pr√ºfen!)"}

          AUFGABE:
          1. Suche nach Bugs, Sicherheitsl√ºcken und Clean Code Verst√∂√üen.
          2. PR√úFE TESTS: Wenn neue Logik ohne Tests kommt -> Schreibe **‚ö†Ô∏è TESTS FEHLEN**.
          3. SPRACHE: Kommentare/Namen m√ºssen Englisch sein.
          4. STIL: Keine unn√∂tigen Einleitungen.
          
          ANTWORT FORMAT (Markdown):
          ### üõ°Ô∏è Review Zusammenfassung
          (Urteil & Status)

          ### üêõ Bugs & Anmerkungen
          (Kritische Fehler)

          ### üß™ Fehlende Tests & Szenarien
          (Analysiere konkret: Was fehlt? Happy Path? Edge Cases?)
          
          CODE DIFF:
          {diff_text[:300000]}
          '''
          # Gemini 3 hat gro√ües Context Window, habe Limit auf 300k erh√∂ht

          # --- 4. KI ANFRAGE ---
          try:
              print(f"üöÄ Sende Anfrage an {MODEL_NAME}...")
              model = genai.GenerativeModel(MODEL_NAME)
              response = model.generate_content(prompt)
              review_body = response.text
          except Exception as e:
              review_body = f"‚ùå **KI-Fehler:** {str(e)}"
              print(review_body)

          # --- 5. POSTEN ---
          header = f'## ü§ñ Gemini Review ({MODEL_NAME})\n'
          pr.create_issue_comment(header + review_body)
          print("‚úÖ Review gepostet!")
          EOF

          python review.py